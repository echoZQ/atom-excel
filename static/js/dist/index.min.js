var $=require("./assets/js/jquery.min.js"),fs=require("fs"),xlsx=require("xlsx"),nodeXlsx=require("node-xlsx"),curfile=null,workbookBook=null,workbookTel=null,filesObj=null,outputArr=[],titles=[],filePath="";document.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),filesObj=e.dataTransfer.files,filePath=filesObj[0].path.replace(filesObj[0].name,"output.xlsx"),$("#fileNames span").eq(0).text(filesObj[0].name).end().eq(1).text(filesObj[1].name)},!1),document.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),$("body").on("click","#button",function(){return null===filesObj?(alert("请先导入文件"),void $("#fileNames span").eq(0).text("").end().eq(1).text("")):($("#mask").show(),$(this).val("处理中").attr("disabled","disabled"),getFilesPath(filesObj),void 0)});var reset=function(){filesObj=null,$("#mask").fadeOut(),$("#button").val("开始处理").removeAttr("disabled"),$("#fileNames span").text("")},getFilesPath=function(e){var t=e.length,r={},o="",l=0;if(!e||1>=t||t>2)return alert("请同时导入两个文件!"),void reset();for(l=0;t>l;l++)o=e[l].path,o.indexOf("book")>=0?r.book=o:o.indexOf("telephone")>=0&&(r.tel=o);return r.hasOwnProperty("book")&&r.hasOwnProperty("tel")?(outputArr=[],title=[],dealWithExcel(e),void 0):(alert("文件添加错误!"),void reset())},dealWithExcel=function(e){if(null===xlsx)return void reset();{var t=Array.prototype.slice,r=t.call(e),o=new FileReader;e.length}o.onload=function(e){var t=e.target.result;curfile.name.indexOf("book")>=0?workbookBook=xlsx.read(t,{type:"binary"}):workbookTel=xlsx.read(t,{type:"binary"}),r.length>0?(curfile=r.shift(),o.readAsBinaryString(curfile)):null!==workbookBook&&null!==workbookTel&&dealWithWorksheet()},curfile=r.shift(),o.readAsBinaryString(curfile)},dealWithWorksheet=function(){var e=workbookBook.SheetNames,t=workbookTel.SheetNames,r=workbookBook.Sheets[e[0]],o=workbookTel.Sheets[t[0]],l=xlsx.utils.sheet_to_json(r),i=xlsx.utils.sheet_to_json(o),n="";for(attribute in i[0])"__rowNum__"!==attribute&&(n=attribute);var a=l.length,s=i.length,u="",f=0,d=0;for(k in l[0])"__rowNum__"!==k&&titles.push(k);outputArr.push(titles);for(var d=0;a>d;d++){u=l[d];for(var f=0;s>f;f++){targrt=i[f][n];var b=[];if(u[n].indexOf(targrt)>=0){for(p in u)"__rowNum__"!==p&&b.push(u[p]);outputArr.push(b)}}}writeWorkbook()},writeWorkbook=function(){var e=nodeXlsx.build([{name:"output",data:outputArr}]);fs.writeFileSync(filePath,e,"binary"),reset(),setTimeout(function(){alert("处理完毕,文件已成功导出!")},500)};